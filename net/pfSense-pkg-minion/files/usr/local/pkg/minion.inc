<?php
/*
	minion.inc
*/
require_once('config.inc');
require_once('interfaces.inc');
require_once('service-utils.inc');
require_once('util.inc');
require_once('system.inc');

define('MINION_BASE', '/usr/local/minion');

function minion_write_config() {
        global $config;
        if (isset($config['installedpackages']['minion']['config'][0])) {
                $minion_config = $config['installedpackages']['minion']['config'][0];
        } else {
                $minion_config = array();
        }
        $id = system_get_serial();
        $location = $minion_config['location'];
        $httpurl = $minion_config['httpurl'];
        $brokerurl = $minion_config['brokerurl'];

        // Construct the Minion configuration
        $minionconfig = <<<EOF
# org.opennms.minion.controller.cfg This file was automatically generated by the pfSense pacakge
# manager. Do not edit this file, it will be overwritten automatically.
# See /usr/local/pkg/minion.inc to make changes to this file!
id = ${id}
location = ${location}
http-url = ${httpurl}
broker-url = ${brokerurl}
EOF;

        // Write the configuration to disk
        safe_mkdir(MINION_BASE . "/etc");
        $fd = fopen(MINION_BASE . "/etc/org.opennms.minion.controller.cfg", "w");
        fwrite($fd, $minionconfig);
        fclose($fd);
}

function minion_write_rcfile() {
        global $config;
        if (isset($config['installedpackages']['minion']['config'][0])) {
                $minion_config = $config['installedpackages']['minion']['config'][0];
        } else {
                $minion_config = array();
        }

        $instance_id = $minion_config['instance_id'];

        $start = "if [ ! -d /dev/fd ]; then\n";
        $start .= "     /sbin/mount -t fdescfs fdesc /dev/fd\n";
        $start .= "fi\n";
        $start .= "if [ ! -d /proc/0 ]; then\n";
        $start .= "     /bin/mkdir -p /proc\n";
        $start .= "     /sbin/mount -t procfs procfs /proc\n";
        $start .= "fi\n";
        $start .= "export JAVA_HOME=/usr/local/openjdk8\n";
        $start .= "/usr/bin/killall java >/dev/null 2>&1\n";
        if (!empty($instance_id)) {
                $start .= "export JAVA_OPTS=\"-Dorg.opennms.instance.id=" . $instance_id . "\"\n";
        }
        $start .= MINION_BASE . "/bin/start\n";

        $stop = "export JAVA_HOME=/usr/local/openjdk8\n";
        $stop .= "/usr/bin/timeout 10 " . MINION_BASE . "/bin/stop\n";
        $stop .= "/usr/bin/killall java >/dev/null 2>&1\n";
        $stop .= "rm -f " . MINION_BASE . "/lock\n";
        $stop .= "exit 0\n";

        write_rcfile(array(
                "file" => "minion",
                "start" => $start,
                "stop" => $stop
                )
        );
}

function minion_generate_ssh_key() {
	if (!file_exists(MINION_BASE . "/etc/host.key")) {
		exec('whoami');

	}

}

function minion_generate_host_key() {
	$host_key = MINION_BASE . "/etc/host.key";
	if (!file_exists($host_key)) {
		exec("/usr/bin/ssh-keygen -t rsa -N '' -b 4096 -f " . $host_key);
	}
}

function minion_sync() {
        global $config;
        conf_mount_rw();

        if (is_service_running("minion")) {
                stop_service("minion");
        }

        // Update the settings
        minion_write_config();

        // Is package enabled?
        if ($config['installedpackages']['minion']['config'][0]['enable']) {
                minion_generate_host_key();
                minion_write_rcfile();
                // The init script requires bash now
                symlink("/usr/local/bin/bash", "/bin/bash");
                // /etc/rc.start_packages invokes a sync before calling the rc script
                // so we can't start the service here without having start_service() called
                // twice on system startup
                // start_service("minion");
        } else {
                unlink_if_exists("/usr/local/etc/rc.d/minion");
        }

        conf_mount_ro();
}

?>
